(function(){"undefined"===typeof window&&(window=root);window.excelFormulaUtilities=window.excelFormulaUtilities||{};var v=window.excelFormulaUtilities.core={};window.excelFormulaUtilities.string=window.excelFormulaUtilities.string||{};window.excelFormulaUtilities.string.formatStr=function(k){for(var p=k,l=1;l<arguments.length;l++)p=p.replace(RegExp("\\{{1}"+(l-1).toString()+"{1}\\}{1}","g"),arguments[l]);return p};window.excelFormulaUtilities.string.trim=function(k){return k.replace(/^\s|\s$/,"")};
window.excelFormulaUtilities.string.trim=function(k){return k.replace(/^(?:\s|&nbsp;|<\s*br\s*\/*\s*>)*|(?:\s|&nbsp;|<\s*br\s*\/*\s*>)*$/,"")};var y=v.isFunction=function(k){return"function"===typeof k},C=v.isArray=function(k){return"object"===typeof k&&k.length},z=v.isWindow=function(){return obj&&"object"===typeof obj&&"setInterval"in obj},A=v.isPlainObject=function(k){if(!k||("object"!==typeof k||k.nodeType||z(k))||k.constructor&&!hasOwnProperty.call(k,"constructor")&&!hasOwnProperty.call(k.constructor.prototype,
"isPrototypeOf"))return!1;for(var p in k);return void 0===p||hasOwnProperty.call(k,p)};v.extend=function(){var k,p,l,s,m,q=arguments[0]||{},j=1,x=arguments.length,n=!1;"boolean"===typeof q&&(n=q,q=arguments[1]||{},j=2);"object"!==typeof q&&!y(q)&&(q={});x===j&&(q=this,--j);for(;j<x;j++)if(null!=(k=arguments[j]))for(p in k)l=q[p],s=k[p],q!==s&&(n&&s&&(A(s)||(m=C(s)))?(m?(m=!1,l=l&&C(l)?l:[]):l=l&&A(l)?l:{},q[p]=v.extend(n,l,s)):void 0!==s&&(q[p]=s));return q}})();(function(){function v(e,c,b){this.value=e;this.type=c;this.subtype=b}function y(){this.items=[];this.add=function(e,c,b){b||(b="");e=new v(e,c,b);this.addRef(e);return e};this.addRef=function(e){this.items.push(e)};this.index=-1;this.reset=function(){this.index=-1};this.BOF=function(){return 0>=this.index};this.EOF=function(){return this.index>=this.items.length-1};this.moveNext=function(){if(this.EOF())return!1;this.index+=1;return!0};this.current=function(){return-1===this.index?null:this.items[this.index]};
this.next=function(){return this.EOF()?null:this.items[this.index+1]};this.previous=function(){return 1>this.index?null:this.items[this.index-1]}}function C(){this.items=[];this.push=function(e){this.items.push(e)};this.pop=function(e){var c=this.items.pop();return new v(e||"",c.type,t)};this.token=function(){return 0<this.items.length?this.items[this.items.length-1]:null};this.value=function(){return this.token()?this.token().value.toString():""};this.type=function(){return this.token()?this.token().type.toString():
""};this.subtype=function(){return this.token()?this.token().subtype.toString():""}}function z(e){for(var c=new y,b=new C,d=0,f=function(){return e.substr(d,1)},a="",h=!1,g=!1,j=!1,k=!1,l=/^[1-9]{1}(\.[0-9]+)?E{1}$/;0<e.length;)if(" "===e.substr(0,1))e=e.substr(1);else{"="===e.substr(0,1)&&(e=e.substr(1));break}for(;!(d>=e.length);)if(h)'"'===f()?'"'===e.substr(d+1,1)?(a+='"',d+=1):(h=!1,c.add(a,n,M),a=""):a+=f(),d+=1;else if(g)"'"===f()?"'"===e.substr(d+1,1)?(a+="'",d+=1):g=!1:a+=f(),d+=1;else if(j)"]"===
f()&&(j=!1),a+=f(),d+=1;else if(k)a+=f(),d+=1,-1!==",#NULL!,#DIV/0!,#VALUE!,#REF!,#NAME?,#NUM!,#N/A,".indexOf(","+a+",")&&(k=!1,c.add(a,n,N),a="");else if(-1!=="+-".indexOf(f())&&1<a.length&&a.match(l))a+=f(),d+=1;else if('"'===f())0<a.length&&(c.add(a,D),a=""),h=!0,d+=1;else if("'"===f())0<a.length&&(c.add(a,D),a=""),g=!0,d+=1;else if("["===f())j=!0,a+=f(),d+=1;else if("#"===f())0<a.length&&(c.add(a,D),a=""),k=!0,a+=f(),d+=1;else if("{"===f())0<a.length&&(c.add(a,D),a=""),b.push(c.add("ARRAY",r,
u)),b.push(c.add("ARRAYROW",r,u)),d+=1;else if(";"===f())0<a.length&&(c.add(a,n),a=""),c.addRef(b.pop()),c.add(",",E),b.push(c.add("ARRAYROW",r,u)),d+=1;else if("}"===f())0<a.length&&(c.add(a,n),a=""),c.addRef(b.pop("ARRAYROWSTOP")),c.addRef(b.pop("ARRAYSTOP")),d+=1;else if(" "===f()){0<a.length&&(c.add(a,n),a="");c.add("",I);for(d+=1;" "===f()&&!(d>=e.length);)d+=1}else-1!==",>=,<=,<>,".indexOf(","+e.substr(d,2)+",")?(0<a.length&&(c.add(a,n),a=""),c.add(e.substr(d,2),w,F),d+=2):(-1!=="+-*/^&=><".indexOf(f())?
(0<a.length&&(c.add(a,n),a=""),c.add(f(),w)):-1!=="%".indexOf(f())?(0<a.length&&(c.add(a,n),a=""),c.add(f(),G)):"("===f()?0<a.length?(b.push(c.add(a,r,u)),a=""):b.push(c.add("",B,u)):","===f()?(0<a.length&&(c.add(a,n),a=""),b.type()!==r?c.add(f(),w,O):c.add(f(),E)):")"===f()?(0<a.length&&(c.add(a,n),a=""),c.addRef(b.pop())):a+=f(),d+=1);0<a.length&&c.add(a,n);for(b=new y;c.moveNext();)a=c.current(),a.type.toString()===I?(f=(f=(f=c.BOF()||c.EOF())&&(c.previous().type.toString()===r&&c.previous().subtype.toString()===
t||c.previous().type.toString()===B&&c.previous().subtype.toString()===t||c.previous().type.toString()===n))&&(c.next().type.toString()===r&&c.next().subtype.toString()===u||c.next().type.toString()===B&&c.next().subtype.toString()===u||c.next().type.toString()===n))&&b.add(a.value.toString(),w,P):b.addRef(a);for(;b.moveNext();)a=b.current(),a.type.toString()===w&&"-"===a.value.toString()?b.BOF()?a.type=J.toString():b.previous().type.toString()===r&&b.previous().subtype.toString()===t||b.previous().type.toString()===
B&&b.previous().subtype.toString()===t||b.previous().type.toString()===G||b.previous().type.toString()===n?a.subtype=H.toString():a.type=J.toString():a.type.toString()===w&&"+"===a.value.toString()?b.BOF()?a.type=x.toString():b.previous().type.toString()===r&&b.previous().subtype.toString()===t||b.previous().type.toString()===B&&b.previous().subtype.toString()===t||b.previous().type.toString()===G||b.previous().type.toString()===n?a.subtype=H.toString():a.type=x.toString():a.type.toString()===w&&
0===a.subtype.length?a.subtype=-1!=="<>=".indexOf(a.value.substr(0,1))?F.toString():"&"===a.value.toString()?Q.toString():H.toString():a.type.toString()===n&&0===a.subtype.length?a.subtype=isNaN(parseFloat(a.value))?"TRUE"===a.value.toString()||"FALSE"===a.value.toString()?F.toString():K.toString():R.toString():a.type.toString()===r&&"@"===a.value.substr(0,1)&&(a.value=a.value.substr(1).toString());b.reset();for(c=new y;b.moveNext();)b.current().type.toString()!==x&&c.addRef(b.current());c.reset();
return c}function A(e,c){if(!RegExp("[a-z]+[0-9]+:[a-z]+[0-9]+","gi").test(e))throw"This is not a valid range: "+e;for(var b=e.split(":"),d=b[0].match(/[0-9]+/gi)[0],f=b[0].match(/[A-Z]+/gi)[0],a=b[1].match(/[0-9]+/gi)[0],b=b[1].match(/[A-Z]+/gi)[0],d=a-d+1,f=k(b)-k(f)+1,a=0,b=1,h="",g="";b<=d;b+=1){for(;a<f;a+=1){var h=a,h=Math.abs(h),j="",l=!1,n=void 0;do n=h%26,l&&25>h&&n--,j=String.fromCharCode(n+65)+j,h=Math.floor((h-n)/26),l=!0;while(0<h);h=j+b;g+=h+(b===d&&a===f-1?"":c)}a=0}return g}function k(e){e=
e.toUpperCase();var c=0,b=1;if(null!==e&&"undefined"!==typeof e&&0<e.length)for(c=e.charCodeAt(0)-65;b<e.length;b++)c=0===c?26:26*c,c+=e.charCodeAt(b)-65;return c}function p(e,c,b,d,f,a){a=void 0===typeof a||null===a?null:a;var h=function(a){return a.replace(/\{\{token\}\}/gi,"{0}").replace(/\{\{autoindent\}\}/gi,"{1}").replace(/\{\{autolinebreak\}\}/gi,"{2}")},g="",g="text"===e.subtype||"text"===e.type?e.value.toString():(0===e.value.length?" ":e.value.toString()).split(" ").join("").toString();
if("function"===typeof f&&(f=f(g,e,b,d),g=f.tokenString,!f.useTemplate))return g;switch(e.type){case "function":switch(e.value){case "ARRAY":g=m(h(c.tmplFunctionStartArray),g,b,d);break;case "ARRAYROW":g=m(h(c.tmplFunctionStartArrayRow),g,b,d);break;default:g="start"===e.subtype.toString()?m(h(c.tmplFunctionStart),g,b,d):m(h(c.tmplFunctionStop),g,b,d)}break;case "operand":switch(e.subtype.toString()){case "error":g=m(h(c.tmplOperandError),g,b,d);break;case "range":g=m(h(c.tmplOperandRange),g,b,d);
break;case "number":g=m(h(c.tmplOperandNumber),g,b,d);break;case "text":g=m(h(c.tmplOperandText),g,b,d);break;case "argument":g=m(h(c.tmplArgument),g,b,d)}break;case "operator-infix":case "logical":g=m(h(c.tmplOperandLogical),g,b,d);break;case "argument":g="argument"!==a.type?m(h(c.tmplArgument),g,b,d):m(h("{{autoindent}}"+c.tmplArgument),g,b,d);break;case "subexpression":g="start"===e.subtype.toString()?m(h(c.tmplSubexpressionStart),g,b,d):m(h(c.tmplSubexpressionStop),g,b,d)}return g}"undefined"===
typeof window&&(window=root);var l=window.excelFormulaUtilities=window.excelFormulaUtilities||{},s=window.excelFormulaUtilities.core,m=window.excelFormulaUtilities.string.formatStr,q=window.excelFormulaUtilities.string.trim,j={},x=j.TOK_TYPE_NOOP="noop",n=j.TOK_TYPE_OPERAND="operand",r=j.TOK_TYPE_FUNCTION="function",B=j.TOK_TYPE_SUBEXPR="subexpression",E=j.TOK_TYPE_ARGUMENT="argument",J=j.TOK_TYPE_OP_PRE="operator-prefix",w=j.TOK_TYPE_OP_IN="operator-infix",G=j.TOK_TYPE_OP_POST="operator-postfix",
I=j.TOK_TYPE_WSPACE="white-space",D=j.TOK_TYPE_UNKNOWN="unknown",u=j.TOK_SUBTYPE_START="start",t=j.TOK_SUBTYPE_STOP="stop",M=j.TOK_SUBTYPE_TEXT="text",R=j.TOK_SUBTYPE_NUMBER="number",F=j.TOK_SUBTYPE_LOGICAL="logical",N=j.TOK_SUBTYPE_ERROR="error",K=j.TOK_SUBTYPE_RANGE="range",H=j.TOK_SUBTYPE_MATH="math",Q=j.TOK_SUBTYPE_CONCAT="concatenate",P=j.TOK_SUBTYPE_INTERSECT="intersect",O=j.TOK_SUBTYPE_UNION="union";l.parseFormula=function(e,c){var b=0,d=document.getElementById(e),f=z(d.value),a;a="<table cellspacing='0' style='border-top: 1px #cecece solid; margin-top: 5px; margin-bottom: 5px'><tr>";
a+="<td class='token' style='font-weight: bold; width: 50px'>index</td>";a+="<td class='token' style='font-weight: bold; width: 125px'>type</td>";a+="<td class='token' style='font-weight: bold; width: 125px'>subtype</td>";a+="<td class='token' style='font-weight: bold; width: 150px'>token</td>";for(a+="<td class='token' style='font-weight: bold; width: 300px'>token tree</td></tr>";f.moveNext();){var h=f.current();h.subtype===t&&(b-=0<b?1:0);a+="<tr>";a+="<td class='token'>"+(f.index+1)+"</td>";a+=
"<td class='token'>"+h.type+"</td>";a+="<td class='token'>"+(0===h.subtype.length?"&nbsp;":h.subtype.toString())+"</td>";a+="<td class='token'>"+(0===h.value.length?"&nbsp;":h.value).split(" ").join("&nbsp;")+"</td>";for(var g="|",j=0;j<b;j+=1)g+="&nbsp;&nbsp;&nbsp;|";a+="<td class='token'>"+g+(0===h.value.length?"&nbsp;":h.value).split(" ").join("&nbsp;")+"</td>";a+="</tr>";h.subtype===u&&(b+=1)}a+="</table>";document.getElementById(c).innerHTML=a;d.select();d.focus()};var L=l.formatFormula=function(e,
c){e=e.replace(/^\s*=\s+/gi,"=");var b={tmplFunctionStart:"{{autoindent}}{{token}}(\n",tmplFunctionStop:"\n{{autoindent}}{{token}})",tmplOperandError:" {{token}}",tmplOperandRange:"{{autoindent}}{{token}}",tmplOperandLogical:" {{token}}{{autolinebreak}}",tmplOperandNumber:"{{autoindent}}{{token}}",tmplOperandText:'{{autoindent}}"{{token}}"',tmplArgument:"{{token}}\n",tmplFunctionStartArray:"",tmplFunctionStartArrayRow:"{",tmplFunctionStopArrayRow:"}",tmplFunctionStopArray:"",tmplSubexpressionStart:"{{autoindent}}(\n",
tmplSubexpressionStop:"\n)",tmplIndentTab:"\t",tmplIndentSpace:" ",autoLineBreak:"TOK_TYPE_FUNCTION | TOK_TYPE_ARGUMENT | TOK_SUBTYPE_LOGICAL | TOK_TYPE_OP_IN ",newLine:"\n",customTokenRender:null,prefix:"",postfix:""};c=c?s.extend(!0,b,c):b;for(var b=0,d=z(e),f="",a=c.autoLineBreak.replace(/\s/gi,"").split("|"),h=!0,g=null;d.moveNext();){var k=d.current(),l=d.next();k.subtype.toString()===t&&(b-=0<b?1:0);var n=RegExp(c.newLine+"$","");a:{for(var m=0;m<a.length;m+=1)if(null!==l&&"undefined"!==typeof l&&
(j[a[m]]===l.type.toString()||j[a[m]]===l.subtype.toString())){l=!0;break a}l=!1}if(h){h="";for(m=0;m<b;m+=1)h+=c.tmplIndentTab}else h=c.tmplIndentSpace;f+=p(k,c,h,l?c.newLine:"",c.customTokenRender,g);k.subtype.toString()===u&&(b+=1);h=l||n.test(f);g=k}return f=c.prefix+q(f)+c.postfix};l.formatFormulaHTML=function(e){return L(e,{tmplFunctionStart:'{{autoindent}}<span class="function">{{token}}</span><span class="function_start">(</span><br />',tmplFunctionStop:'<br />{{autoindent}}{{token}}<span class="function_stop">)</span>',
tmplOperandError:"{{token}}",tmplOperandRange:"{{autoindent}}{{token}}",tmplOperandLogical:" {{token}}{{autolinebreak}}",tmplOperandNumber:"{{autoindent}}{{token}}",tmplOperandText:'{{autoindent}}<span class="quote_mark">"</span><span class="text">{{token}}</span><span class="quote_mark">"</span>',tmplArgument:"{{token}}<br />",tmplFunctionStartArray:"",tmplFunctionStartArrayRow:"{",tmplFunctionStopArrayRow:"}",tmplFunctionStopArray:"",tmplSubexpressionStart:"{{autoindent}}(",tmplSubexpressionStop:" )",
tmplIndentTab:'<span class="tabbed">&nbsp;&nbsp;&nbsp;&nbsp;</span>',tmplIndentSpace:"&nbsp;",newLine:"<br />",autoLineBreak:"TOK_TYPE_FUNCTION | TOK_TYPE_ARGUMENT | TOK_SUBTYPE_LOGICAL | TOK_TYPE_OP_IN ",trim:!0,prefix:"=",customTokenRender:null})};var S=l.formula2CSharp=function(e){var c=[];return L(e,{tmplFunctionStart:"{{token}}(",tmplFunctionStop:"{{token}})",tmplOperandError:"{{token}}",tmplOperandRange:"{{token}}",tmplOperandLogical:"{{token}}",tmplOperandNumber:"{{token}}",tmplOperandText:'"{{token}}"',
tmplArgument:"{{token}}",tmplFunctionStartArray:"",tmplFunctionStartArrayRow:"{",tmplFunctionStopArrayRow:"}",tmplFunctionStopArray:"",tmplSubexpressionStart:"(",tmplSubexpressionStop:")",tmplIndentTab:"\t",tmplIndentSpace:" ",autoLineBreak:"TOK_SUBTYPE_STOP | TOK_SUBTYPE_START | TOK_TYPE_ARGUMENT",trim:!0,customTokenRender:function(b,d){var f="",a={"=":"==","<>":"!=",MIN:"Math.Min",MAX:"Math.Max",ABS:"Math.ABS",SUM:"",IF:"","&":"+"},e=c[c.length-1],g=!1;switch(d.type.toString()){case r:switch(d.subtype){case u:c.push({name:b,
argumentNumber:0});f="string"===typeof a[b.toUpperCase()]?a[b.toUpperCase()]:b;g=!0;break;case t:g=!0;switch(e.name.toLowerCase()){case "if":f=")";g=!1;break;default:f="string"===typeof a[b.toUpperCase()]?a[b.toUpperCase()]:b}c.pop()}break;case E:switch(e.name.toLowerCase()){case "if":switch(e.argumentNumber){case 0:f="?";break;case 1:f=":"}break;case "sum":f="+";break;default:f="string"===typeof a[b.toUpperCase()]?a[b.toUpperCase()]:b,g=!0}e.argumentNumber+=1;break;case n:switch(d.subtype){case K:switch(e.name.toLowerCase()){case "sum":RegExp(":",
"gi").test(b)?f=A(b,"+"):outStr=b;break;default:f=RegExp(":","gi").test(b)?"["+A(b,",")+"]":b}break}default:""===f&&(f="string"===typeof a[b.toUpperCase()]?a[b.toUpperCase()]:b),g=!0}return{tokenString:f,useTemplate:g}}})};l.formula2JavaScript=function(e){return S(e).replace("==","===")};l.getTokens=z})();
